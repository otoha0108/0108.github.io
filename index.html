<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸŒ HELL0w0RLD! ğŸŒ â€” fixed</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

    body {
      background: #0f0f0f;
      color: #00fff2;
      font-family: 'DotGothic16', 'ï¼­ï¼³ ã‚´ã‚·ãƒƒã‚¯', 'MS Gothic', 'Osaka-Mono', monospace;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      font-size: 16px;
    }

    #app {
      width: 95%;
      max-width: 640px;
      border: 2px solid #14ffec;
      border-radius: 8px;
      background: #151515;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      height: 90vh;
      position: relative;
    }

    h1 { margin: 0; color: #14ffec; text-align: center; }

    #lang-toggle { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; z-index: 1000; }
    #lang-toggle button { font-family: inherit; font-size: 12px; padding: 2px 6px; background-color: #e6007e; border: none; color: #ffffff; cursor: pointer; border-radius: 4px; }
    #lang-toggle button.active { background-color: #14ffec; color: #151515; }

    #loader { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; text-align: center; }
    #loader .bar { width: 300px; height: 15px; border: 1px solid #00fff2; margin-top: 10px; position: relative; overflow: hidden; }
    #loader .bar-fill { height: 100%; background: #00fff2; width: 0%; animation: loadbar 3s forwards; }
    @keyframes loadbar { 0% { width: 0%; } 100% { width: 100%; } }

    #title { display: none; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; text-align: center; opacity: 0; animation: fadeIn 1s forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    #usernameScreen { display: none; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; text-align: center; }
    #usernameScreen input { margin: 10px 0; padding: 8px 12px; background: #111; color: #00fff2; border: 1px solid #00fff2; border-radius: 4px; font-family: inherit; font-size: 14px; }
    #usernameScreen button { padding: 8px 16px; background: #14ffec; color: #151515; border: none; border-radius: 4px; font-family: inherit; cursor: pointer; }

    #largeTitle { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); font-size: 20px; color: #14ffec; display: none; z-index: 500; text-align: center; text-shadow: 0 0 10px #14ffec; max-width: 80%; word-wrap: break-word; }

    #overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.85); z-index: 1000; text-align: center; padding: 20px; color: #00fff2; box-sizing: border-box; }

    #output { flex-grow: 1; overflow-y: auto; margin-bottom: 12px; margin-top: 80px; padding-right: 4px; }

    .message { margin: 4px 0; padding: 6px 10px; border-radius: 8px; line-height: 1.4; max-width: 90%; word-wrap: break-word; }
    .log { background-color: #073b3a; color: #14ffec; align-self: flex-start; }

    #promptSection { display: none; }
    #promptText { margin: 0 0 8px; }

    #buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
    #rankingBtn { grid-column: 1 / -1; background: #e6007e; color: #ffffff; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; cursor: pointer; font-family: inherit; margin-top: 8px; z-index: 100; position: relative; }
    #rankingBtn:hover { background: #ff1493; }
    #rankingBtn:active { background: #c71585; }
    #buttons button { background: #14ffec; color: #151515; border: none; padding: 8px; border-radius: 6px; font-size: 1em; cursor: pointer; font-family: inherit; }
    #buttons button.disabled { opacity: 0.4; cursor: not-allowed; }
    #buttons button.locked { opacity: 0.4; cursor: not-allowed; position: relative; }
    #buttons button.locked::after { content: 'ğŸ”’'; position: absolute; top: 50%; right: 8px; transform: translateY(-50%); }

    .heart-scanner { position: relative; width: 200px; height: 200px; margin: 20px auto; background: #001122; border: 2px solid #00fff2; border-radius: 8px; overflow: hidden; }
    .heart-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; color: #14ffec; z-index: 1; }
    .scan-line { position: absolute; top: -5px; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, transparent, #00fff2, transparent); box-shadow: 0 0 10px #00fff2; animation: heartScan 2s linear infinite; z-index: 2; }
    @keyframes heartScan { 0% { top: -5px; } 100% { top: 205px; } }
    .scan-grid { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(rgba(0, 255, 242, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 242, 0.1) 1px, transparent 1px); background-size: 20px 20px; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    .connection-status { position: absolute; top: 8px; left: 8px; font-size: 10px; padding: 2px 6px; border-radius: 3px; z-index: 1000; }
    .connection-status.online { background: #00ff00; color: #000; }
    .connection-status.offline { background: #ff0000; color: #fff; }

    .ranking { margin-top: 16px; text-align: left; font-size: 12px; }
    .world-stats { margin-top: 12px; padding: 8px; background: rgba(0, 0, 0, 0.5); border-radius: 6px; font-size: 10px; color: #888; }
  </style>
</head>
<body>
  <div id="app">
    <div id="connection-status" class="connection-status offline">OFFLINE</div>

    <div id="lang-toggle">
      <button id="btn-en" class="active">ENGLISH</button>
      <button id="btn-ja">æ—¥æœ¬èª</button>
    </div>

    <div id="largeTitle">ğŸŒHELL0w0RLD!ğŸŒ</div>

    <div id="loader">
      <h2 id="loaderText">0108 connectingâ€¦</h2>
      <div class="bar"><div class="bar-fill"></div></div>
    </div>

    <div id="title"><h1>ğŸŒHELL0w0RLD!ğŸŒ</h1></div>

    <div id="usernameScreen">
      <h2 id="enterNameText">Enter your name:</h2>
      <input type="text" id="usernameInput" placeholder="Your name here" />
      <br />
      <button id="startBtn">Start</button>
    </div>

    <div id="output"></div>

    <div id="promptSection">
      <h2 id="promptText">ğŸ“¡ 0108: What's on your mind?</h2>
      <div id="buttons">
        <button id="btn-sos">sos</button>
        <button id="btn-lonely">lonely</button>
        <button id="btn-hate">hate myself</button>
        <button id="btn-why" class="locked">why</button>
      </div>
      <button id="rankingBtn">ğŸ“Š View Rankings</button>
    </div>

    <div id="overlay"></div>
  </div>

  <script>
    // ===== Utilities =====
    class IntervalManager {
      constructor() { this.intervals = new Set(); this.isCleanedUp = false; }
      setInterval(cb, d) { if (this.isCleanedUp) return null; const id = setInterval(cb, d); this.intervals.add(id); return id; }
      clearInterval(id) { if (id) { clearInterval(id); this.intervals.delete(id); } }
      clearAll() { this.intervals.forEach(id => clearInterval(id)); this.intervals.clear(); this.isCleanedUp = true; }
    }
    const intervalManager = new IntervalManager();

    // ===== Config & i18n =====
    const RANKING_CONFIG = { endpoints:[
      'https://jsonplaceholder.typicode.com/posts',
      'https://httpbin.org/anything',
      'https://api.github.com/zen'
    ], rankingEndpoint:'https://api.jsonstorage.net/v1/json/hellowworld-ranking/create',
      getEndpoint:'https://api.jsonstorage.net/v1/json/hellowworld-ranking', maxEntries:50, cacheDuration:3000, retryAttempts:2 };

    const translations = {
      en: { connect:'0108 connectingâ€¦', enterName:'Enter your name:', start:'Start', prompt:"ğŸ“¡ 0108: What's on your mind?", scanInit:'0108 can catch your signal anytime!', scanProgress:'Scanning your heart...', virusDetected:'ğŸš¨ Virus detected!', virusBtn:'Launch Virus Buster!', virusClean:'âœ… Virus eliminated!\nHeart status: 150% clean.', close:'Close', logPrefix:': ', virusesLeft:'Viruses left', scoreLabel:'Score', timeLabel:'Time', rankingTitle:'â­ GLOBAL RANKINGS â­', viewRankings:'View Rankings', onlineRankings:'ğŸŒ GLOBAL ONLINE', offlineRankings:'ğŸ“± LOCAL OFFLINE', yourRank:'Your rank: #', totalPlayers:'Total players worldwide: ' },
      ja: { connect:'0108 æ¥ç¶šä¸­â€¦', enterName:'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', start:'ã‚¹ã‚¿ãƒ¼ãƒˆ', prompt:'ğŸ“¡ 0108: èª¿å­ã¯ã©ã†ï¼Ÿ', scanInit:'0108ã¯ã„ã¤ã§ã‚‚ã‚ãªãŸã®ä¿¡å·ã‚’å—ä¿¡ã§ãã¾ã™ï¼', scanProgress:'ã‚ãªãŸã®å¿ƒã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™...', virusDetected:'ğŸš¨ ã‚¦ã‚¤ãƒ«ã‚¹ç™ºè¦‹ï¼', virusBtn:'ã‚¦ã‚¤ãƒ«ã‚¹ãƒã‚¹ã‚¿ãƒ¼èµ·å‹•ï¼', virusClean:'âœ… ã‚¦ã‚¤ãƒ«ã‚¹ã‚’ã‚„ã£ã¤ã‘ãŸãï¼\nå¿ƒã®çŠ¶æ…‹: 150%ã‚¯ãƒªãƒ¼ãƒ³ã€‚', close:'é–‰ã˜ã‚‹', logPrefix:'ï¼š', virusesLeft:'æ®‹ã‚Šã‚¦ã‚¤ãƒ«ã‚¹', scoreLabel:'ã‚¹ã‚³ã‚¢', timeLabel:'æ™‚é–“', rankingTitle:'â­ ä¸–ç•Œãƒ©ãƒ³ã‚­ãƒ³ã‚° â­', viewRankings:'ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º', onlineRankings:'ğŸŒ ä¸–ç•Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³', offlineRankings:'ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³', yourRank:'ã‚ãªãŸã®é †ä½: ', totalPlayers:'ä¸–ç•Œã®ç·ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ' }
    };
    function t(key){ return translations[currentLang][key] || key; }

    // ===== Lyrics placeholder (fixed) =====
    // å…ƒã®ã‚¨ãƒ©ãƒ¼åŸå› ã ã£ãŸã‚¹ãƒãƒ¼ãƒˆã‚¯ã‚©ãƒ¼ãƒˆãƒ»æ¬ è½æ‹¬å¼§ã‚’é¿ã‘ã‚‹ãŸã‚ã€å¿…è¦ãªã‚‰ã“ã“ã«å®‰å…¨ãªå½¢ã§è¿½åŠ ã—ã¦ãã‚Œã€‚
    const otohaLyrics = {
      "ãƒªã‚¤ãƒ³ã‚«ãƒ¼ãƒãƒ¼ã‚·ãƒ§ãƒ³": `èª°ã‚‚å±…ãªã„é›¨å¤œã¨æ­£å¤¢ ...`,
      "Change": `é­”æ³•ã«ã‹ã‘ã‚‰ã‚ŒãŸã¿ãŸã„ã«å¤‰ã‚ã£ã¦ã ...`,
      "ãƒ‘ãƒ©ãƒ‰ã‚¯ã‚µãƒ¼": `æ›–æ˜§ãªæ„›ãªã‚‰è¦ã‚‰ãªã„ã‹ã‚‰ ...`,
      "IYAIYA": `è…°æ›ã‘ãŸã‚½ãƒ•ã‚¡ãƒ¼ã®ä¸Š ...`,
      "ã‚¢ã‚ºãƒ©ã‚¤ãƒˆ": `ã€Œãƒãƒ­ãƒ¼ãƒãƒ­ãƒ¼ èª¿å­ã¯ã©ã†ï¼Ÿã€ ...`,
      "ifã®ãƒãƒ¼ãƒ¡ã‚¤ãƒ‰": `æ–°ãŸãªç‰©èªã®çµæœ«ã¯ å…¨ã¦ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ã«ã—ã‚ˆã† ...`
    };

    // ===== Ranking manager =====
    class RealTimeRankingManager {
      constructor(){ this.cache=null; this.cacheTime=0; this.isOnline=false; this.retryCount=0; this.sessionId=this.generateSessionId(); this.autoRefreshInterval=null; }
      generateSessionId(){ return 'user_' + Math.random().toString(36).slice(2,11) + '_' + Date.now(); }
      async checkConnection(){
        if (window.location.protocol === 'file:'){ this.isOnline=false; this.updateConnectionStatus(false); return false; }
        for (let i=0;i<RANKING_CONFIG.endpoints.length;i++){
          try{
            const response = await Promise.race([
              fetch(RANKING_CONFIG.endpoints[i], { method:'GET', cache:'no-cache', mode:'cors' }),
              new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),3000))
            ]);
            if(response.ok){ this.isOnline=true; this.updateConnectionStatus(true); return true; }
          }catch(e){ /* noop */ }
        }
        if (navigator.onLine){ this.isOnline=true; this.updateConnectionStatus(true); return true; }
        this.isOnline=false; this.updateConnectionStatus(false); return false;
      }
      updateConnectionStatus(online){ const el=document.getElementById('connection-status'); if(!el) return; el.className = `connection-status ${online?'online':'offline'}`; el.textContent = online ? 'ğŸŒ ONLINE' : 'ğŸ“± OFFLINE'; }
      getOfflineRankings(){ const base=[ {name:'0w0',time:8.2}, {name:'ãœã‚“ã­ã“',time:9.1}, {name:'otoha_0108',time:17.9} ].map(e=>({ ...e, time: e.time + (Math.random()-0.5)*2, date: new Date(Date.now()-Math.random()*7*86400000).toISOString().split('T')[0], offline:true })); const local=JSON.parse(localStorage.getItem('hellowworld_rankings')||'[]'); return [...local, ...base].sort((a,b)=>a.time-b.time).slice(0,20); }
      async simulateOnlineRankings(){ const local=JSON.parse(localStorage.getItem('hellowworld_global_rankings')||'[]'); const global=[ {name:'0w0',time:3.8,online:true}, {name:'ãœã‚“ã­ã“',time:8.9,online:true}, {name:'otoha_0108',time:12.7,online:true} ].map(e=>({ ...e, time:e.time+(Math.random()-0.5)*1.5, date:new Date(Date.now()-Math.random()*2*86400000).toISOString().split('T')[0], timestamp: Date.now()-Math.random()*86400000 })); return [...local, ...global].sort((a,b)=>a.time-b.time).slice(0,RANKING_CONFIG.maxEntries); }
      async loadRankings(){ if(this.cache && (Date.now()-this.cacheTime)<RANKING_CONFIG.cacheDuration) return this.cache; await this.checkConnection(); if(!this.isOnline){ this.cache=this.getOfflineRankings(); this.cacheTime=Date.now(); return this.cache; } const online=await this.simulateOnlineRankings(); this.cache=online; this.cacheTime=Date.now(); return online; }
      saveToGlobalLocal(entry){ try{ const g=JSON.parse(localStorage.getItem('hellowworld_global_rankings')||'[]'); g.push(entry); const sorted=g.sort((a,b)=>a.time-b.time).slice(-30); localStorage.setItem('hellowworld_global_rankings', JSON.stringify(sorted)); }catch(e){}
      }
      async submitScore(userName,time,gameData={}){ const entry={ name:userName.slice(0,20), time:Math.round(time*10)/10, timestamp:Date.now(), date:new Date().toISOString().split('T')[0], sessionId:this.sessionId, online:this.isOnline, ...gameData }; this.saveToGlobalLocal(entry); await this.checkConnection(); if(this.isOnline){ await new Promise(r=>setTimeout(r,800)); if(this.cache){ this.cache.push(entry); this.cache=this.cache.sort((a,b)=>a.time-b.time).slice(0,RANKING_CONFIG.maxEntries); } this.cacheTime=0; return true; } return false; }
      startAutoRefresh(){ if(this.autoRefreshInterval) intervalManager.clearInterval(this.autoRefreshInterval); if(window.location.protocol==='file:') return; this.autoRefreshInterval = intervalManager.setInterval(async()=>{ if(this.isOnline){ this.cacheTime=0; await this.loadRankings(); } }, 10000); }
    }
    const rankingManager = new RealTimeRankingManager();

    // ===== DOM refs =====
    function el(id){ return document.getElementById(id); }
    const elements = { loader:el('loader'), loaderText:el('loaderText'), titleDiv:el('title'), largeTitle:el('largeTitle'), usernameScreen:el('usernameScreen'), enterNameText:el('enterNameText'), startBtn:el('startBtn'), outputDiv:el('output'), promptSection:el('promptSection'), promptText:el('promptText'), overlay:el('overlay'), btnSos:el('btn-sos'), btnLonely:el('btn-lonely'), btnHate:el('btn-hate'), btnWhy:el('btn-why'), btnEn:el('btn-en'), btnJa:el('btn-ja'), rankingBtn:el('rankingBtn') };

    // ===== State =====
    let currentLang = 'en';
    let userName = 'AAA';
    let sosDone=false, lonelyDone=false, hateDone=false;

    // ===== UI helpers =====
    function setLanguage(lang){ if(currentLang===lang) return; currentLang=lang; if(elements.btnEn) elements.btnEn.classList.toggle('active', currentLang==='en'); if(elements.btnJa) elements.btnJa.classList.toggle('active', currentLang==='ja'); if(elements.loaderText) elements.loaderText.textContent=t('connect'); if(elements.enterNameText) elements.enterNameText.textContent=t('enterName'); if(elements.startBtn) elements.startBtn.textContent=t('start'); if(elements.promptText) elements.promptText.textContent=t('prompt'); if(elements.rankingBtn) elements.rankingBtn.textContent='ğŸ“Š '+t('viewRankings'); }

    function showPrompt(){ if(elements.promptText) elements.promptText.textContent=t('prompt'); if(elements.rankingBtn) elements.rankingBtn.textContent='ğŸ“Š '+t('viewRankings'); if(elements.promptSection) elements.promptSection.style.display='block'; if(elements.btnSos) elements.btnSos.classList.remove('disabled'); if(elements.btnLonely) elements.btnLonely.classList.remove('disabled'); if(elements.btnHate) elements.btnHate.classList.remove('disabled'); if(sosDone && lonelyDone && hateDone){ elements.btnWhy.classList.remove('locked','disabled'); } else { elements.btnWhy.classList.add('locked','disabled'); } }

    function addLog(action){ if(!elements.outputDiv) return; const div=document.createElement('div'); div.className='message log'; div.textContent=`${userName}${t('logPrefix')}${action}`; elements.outputDiv.appendChild(div); elements.outputDiv.scrollTop=elements.outputDiv.scrollHeight; }

    function createCloseButton(cb){ const b=document.createElement('button'); b.className='close-btn'; b.textContent=t('close'); b.addEventListener('click', cb); return b; }

    async function displayRankings(){ const rankingDiv=document.createElement('div'); rankingDiv.className='ranking'; const title=document.createElement('div'); title.style.textAlign='center'; title.style.marginBottom='12px'; title.style.color='#ffff00'; title.style.fontSize='14px'; title.style.fontWeight='bold'; title.textContent=t('rankingTitle'); rankingDiv.appendChild(title); const rankings=await rankingManager.loadRankings(); const statusDiv=document.createElement('div'); statusDiv.style.textAlign='center'; statusDiv.style.marginBottom='8px'; statusDiv.style.fontSize='10px'; statusDiv.style.color=rankingManager.isOnline?'#00ff00':'#ff8800'; statusDiv.textContent=rankingManager.isOnline?t('onlineRankings'):t('offlineRankings'); rankingDiv.appendChild(statusDiv); const container=document.createElement('div'); container.style.background='rgba(0,0,0,0.7)'; container.style.padding='12px'; container.style.borderRadius='8px'; container.style.maxHeight='200px'; container.style.overflowY='auto'; rankings.slice(0,15).forEach((entry,idx)=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='3px 0'; row.style.padding='2px 4px'; row.style.fontSize='11px'; const rank=idx+1; let color='#00fff2'; if(rank===1) color='#ffff00'; else if(rank===2) color='#c0c0c0'; else if(rank===3) color='#cd7f32'; const isMe=entry.name===userName; if(isMe){ row.style.background='rgba(255,255,0,0.2)'; row.style.borderRadius='4px'; }
      const left=document.createElement('span'); left.style.color=color; left.textContent=`${rank}. ${entry.name.length>15?entry.name.slice(0,15)+'...':entry.name}`; if(isMe) left.style.fontWeight='bold'; const right=document.createElement('span'); right.style.color=color; right.textContent=`${entry.time.toFixed(1)}s`; if(isMe) right.style.fontWeight='bold'; row.appendChild(left); row.appendChild(right); container.appendChild(row); }); rankingDiv.appendChild(container); const stats=document.createElement('div'); stats.className='world-stats'; const total=rankings.length; const myRank=rankings.findIndex(e=>e.name===userName)+1; let txt=t('totalPlayers')+total; if(myRank>0) txt += `\n${t('yourRank')}${myRank}`; stats.textContent=txt; rankingDiv.appendChild(stats); return rankingDiv; }

    function drawInvader(ctx,x,y,w,h){ const px=2; ctx.fillStyle='#00ffcc'; const pattern=[[ [0,0,1,0,0,0,1,0],[0,0,0,1,0,1,0,0],[0,0,1,1,1,1,1,0],[0,1,1,0,1,0,1,1],[1,1,1,1,1,1,1,1],[1,0,1,1,1,1,0,1],[1,0,1,0,0,1,0,1],[0,0,0,1,1,0,0,0] ]][0]; for(let r=0;r<8;r++){ for(let c=0;c<8;c++){ if(pattern[r][c]) ctx.fillRect(x-w/2 + c*px, y-h/2 + r*px, px, px); } } }

    function startGame(){ return new Promise(resolve=>{ const start=Date.now(); elements.overlay.innerHTML=''; const canvas=document.createElement('canvas'); canvas.width=320; canvas.height=240; canvas.style.background='#001b1a'; canvas.style.border='2px solid #00ffcc'; elements.overlay.appendChild(canvas); const ctx=canvas.getContext('2d'); const board=document.createElement('div'); board.style.marginTop='8px'; board.style.color='#00ffcc'; elements.overlay.appendChild(board); const ship={ x:canvas.width/2-15, y:canvas.height-20, w:30, h:10 }; const bullets=[]; const viruses=[]; let remaining=12; let score=0;
      for(let r=0;r<2;r++){ for(let c=0;c<6;c++){ viruses.push({ x:30+c*40, y:20+r*30, w:20, h:16, vx:(Math.random()>0.5?1:-1), hit:false }); } }
      let anim, over=false;
      function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#ff0077'; ctx.fillRect(ship.x, ship.y, ship.w, ship.h); viruses.forEach(v=>{ if(!v.hit){ v.x += v.vx; if (v.x - v.w/2 < 0 || v.x + v.w/2 > canvas.width) v.vx*=-1; drawInvader(ctx, v.x, v.y, v.w, v.h); } }); for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; b.y -= 4; ctx.fillStyle='#ffff00'; ctx.fillRect(b.x-1, b.y-8, 2, 8); if(b.y<0){ bullets.splice(i,1); continue; } viruses.forEach(v=>{ if(!v.hit){ if(b.x>=v.x-v.w/2 && b.x<=v.x+v.w/2 && b.y>=v.y-v.h/2 && b.y<=v.y+v.h/2){ v.hit=true; remaining--; score++; bullets.splice(i,1); } } }); }
        const tsec=(Date.now()-start)/1000; board.textContent = `${t('virusesLeft')}: ${remaining} | ${t('scoreLabel')}: ${score} | ${t('timeLabel')}: ${tsec.toFixed(1)}s`;
        if(viruses.every(v=>v.hit)) end(true);
        if(!over) anim=requestAnimationFrame(draw);
      }
      function shoot(){ bullets.push({ x: ship.x + ship.w/2, y: ship.y }); }
      function pointerMove(e){ const rect=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left; ship.x = Math.min(Math.max(0, x - ship.w/2), canvas.width - ship.w); }
      const onMouseMove=(e)=>pointerMove(e); const onMouseDown=()=>shoot(); const onTouchMove=(e)=>pointerMove(e); const onTouchStart=()=>shoot();
      canvas.addEventListener('mousemove', onMouseMove); canvas.addEventListener('mousedown', onMouseDown); canvas.addEventListener('touchmove', onTouchMove); canvas.addEventListener('touchstart', onTouchStart);
      function end(success){ if(over) return; over=true; cancelAnimationFrame(anim); canvas.removeEventListener('mousemove', onMouseMove); canvas.removeEventListener('mousedown', onMouseDown); canvas.removeEventListener('touchmove', onTouchMove); canvas.removeEventListener('touchstart', onTouchStart); const finalTime=(Date.now()-start)/1000; resolve({ success, time: finalTime, score }); }
      draw();
    }); }

    // ===== Boot =====
    window.onload = async () => {
      try{ if(elements.loaderText) elements.loaderText.textContent=t('connect'); await rankingManager.checkConnection(); rankingManager.startAutoRefresh(); }catch(e){ rankingManager.isOnline=false; rankingManager.updateConnectionStatus(false); }
      setTimeout(()=>{ if(elements.loader) elements.loader.style.display='none'; if(elements.titleDiv) elements.titleDiv.style.display='flex'; setTimeout(()=>{ if(elements.titleDiv) elements.titleDiv.style.display='none'; if(elements.enterNameText) elements.enterNameText.textContent=t('enterName'); if(elements.startBtn) elements.startBtn.textContent=t('start'); if(elements.usernameScreen) elements.usernameScreen.style.display='flex'; }, 2000); }, 3200);
    };

    // ===== Events =====
    if(elements.btnEn) elements.btnEn.addEventListener('click', ()=>setLanguage('en'));
    if(elements.btnJa) elements.btnJa.addEventListener('click', ()=>setLanguage('ja'));
    if(elements.startBtn) elements.startBtn.addEventListener('click', ()=>{ const input=document.getElementById('usernameInput'); const value=input?input.value.trim():''; userName=value||'AAA'; if(elements.usernameScreen) elements.usernameScreen.style.display='none'; if(elements.largeTitle) elements.largeTitle.style.display='block'; showPrompt(); });

    if(elements.rankingBtn) elements.rankingBtn.addEventListener('click', async()=>{ if(!elements.overlay) return; elements.overlay.innerHTML=''; elements.overlay.style.display='flex'; const view=await displayRankings(); elements.overlay.appendChild(view); const close=createCloseButton(()=>{ elements.overlay.style.display='none'; }); elements.overlay.appendChild(close); });

    // SOS
    if(elements.btnSos) elements.btnSos.addEventListener('click', async ()=>{
      if(elements.btnSos.classList.contains('disabled')) return; elements.btnSos.classList.add('disabled'); addLog('sos'); if(!elements.overlay) return; elements.overlay.innerHTML=''; elements.overlay.style.display='flex'; const msg=document.createElement('div'); msg.textContent=t('scanInit'); elements.overlay.appendChild(msg); const progress=document.createElement('div'); progress.style.marginTop='8px'; progress.textContent=t('scanProgress'); elements.overlay.appendChild(progress); const scanner=document.createElement('div'); scanner.className='heart-scanner'; const heart=document.createElement('div'); heart.className='heart-display'; heart.textContent='â™¡'; scanner.appendChild(heart); const grid=document.createElement('div'); grid.className='scan-grid'; scanner.appendChild(grid); const line=document.createElement('div'); line.className='scan-line'; scanner.appendChild(line); elements.overlay.appendChild(scanner);
      setTimeout(()=>{ msg.textContent=t('virusDetected'); progress.remove(); scanner.remove(); const icon=document.createElement('div'); icon.style.fontSize='120px'; icon.style.margin='20px 0'; icon.style.animation='pulse 0.5s infinite'; icon.style.color='#14ffec'; icon.textContent='ğŸ‘¾'; elements.overlay.appendChild(icon); const buster=document.createElement('button'); buster.textContent=t('virusBtn'); Object.assign(buster.style,{marginTop:'12px',padding:'8px 16px',background:'#14ffec',color:'#151515',border:'none',cursor:'pointer',fontFamily:'inherit'}); elements.overlay.appendChild(buster); buster.addEventListener('click', async()=>{ const result=await startGame(); elements.overlay.innerHTML=''; const done=document.createElement('div'); done.innerHTML=t('virusClean').replace(/\n/g,'<br>'); done.style.marginBottom='16px'; elements.overlay.appendChild(done); await rankingManager.submitScore(userName, result.time, { score: result.score, gameType:'virus_buster' }); const view=await displayRankings(); elements.overlay.appendChild(view); const close=createCloseButton(()=>{ elements.overlay.style.display='none'; sosDone=true; showPrompt(); }); elements.overlay.appendChild(close); }); }, 1800);
    });

    // Placeholder: other buttons can be wired similarly without affecting boot
    if(elements.btnLonely) elements.btnLonely.addEventListener('click', ()=>{ addLog('lonely'); lonelyDone=true; showPrompt(); });
    if(elements.btnHate) elements.btnHate.addEventListener('click', ()=>{ addLog('hate myself'); hateDone=true; showPrompt(); });
  </script>
</body>
</html>
